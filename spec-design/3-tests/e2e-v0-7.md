# V0.7 End-to-End Testing Design

## Overview

This document outlines focused end-to-end testing for the Fuel system through v0.7. Tests verify the complete data flow from database → backend API → frontend UI for all activity log types, plus essential Docker deployment functionality.

## Test Categories

### 1. Infrastructure Tests (Minimal)

#### 1.1 Docker Deployment Tests
- **test_containers_run**: All services start successfully (postgres → backend → frontend)
- **test_health_checks**: All containers report healthy status
- **test_environment_variables**: .env variables loaded properly in containers
- **test_database_connectivity**: Backend can connect to postgres with provided credentials

### 2. End-to-End Data Flow Tests

#### 2.1 Manual Log Event Flow
- **test_manual_log_e2e**:
  - Insert manual activity_logs entry + manual_logs entry directly into database
  - Verify frontend displays new manual log with correct content, timestamp, type
  - Verify frontend can edit manual log content via UI
  - Verify frontend can delete manual log via UI
  - Verify database reflects UI changes

#### 2.2 Git Commit Event Flow
- **test_git_commit_e2e**:
  - Insert git_commit activity_logs entry + git_commits entry directly into database
  - Verify frontend displays git commit log with commit hash, message, author, files changed
  - Verify frontend shows commit as read-only (no edit/delete for git events)
  - Verify frontend can mark git commit as reviewed

#### 2.3 Claude Code Conversation Event Flow
- **test_claude_code_e2e**:
  - Insert claude_code activity_logs entry + claude_code_conversations entry directly into database
  - Verify frontend displays Claude Code conversation with project name, file path, exchange count
  - Verify frontend shows conversation as read-only
  - Verify frontend can mark conversation as reviewed

#### 2.4 Git Checkout Event Flow
- **test_git_checkout_e2e**:
  - Insert git_checkout activity_logs entry + git_checkouts entry directly into database
  - Verify frontend displays checkout event with branch change, repo name, timestamp
  - Verify frontend shows checkout as read-only
  - Verify frontend can mark checkout as reviewed

#### 2.5 Git Hook Installation Event Flow
- **test_git_hooks_e2e**:
  - Insert git_hook_install activity_logs entry + git_hooks_installed entry directly into database
  - Verify frontend displays hook installation with hook type, repo path, installation timestamp
  - Verify frontend shows hook installation as read-only
  - Verify frontend can mark as reviewed

### 3. Complete User Journey Tests

#### 3.1 Filter and Review Workflow
- **test_filtering_and_review_e2e**:
  - Insert multiple activity logs of different types and review states into database
  - Verify frontend displays all logs chronologically
  - Apply date range filter → verify only logs in range shown
  - Apply "unreviewed only" filter → verify only unreviewed logs shown
  - Select multiple logs → bulk mark as reviewed → verify database updated
  - Clear filters → verify all logs shown again

#### 3.2 Manual Log Creation Workflow
- **test_manual_log_creation_e2e**:
  - Use frontend form to create new manual log
  - Verify new entries appear in both activity_logs and manual_logs database tables
  - Verify frontend immediately shows new log in chronological order
  - Verify log has correct type, timestamp, and unreviewed status

#### 3.3 Data Persistence Workflow
- **test_data_persistence_e2e**:
  - Insert test data into database
  - Restart all Docker containers
  - Verify frontend still displays all test data correctly
  - Verify data survived container lifecycle

## Testing Infrastructure

### File Structure
```
fuel/
├── tests/
│   ├── e2e/
│   │   ├── specs/
│   │   │   ├── infrastructure.spec.ts
│   │   │   ├── data-flow.spec.ts
│   │   │   └── workflows.spec.ts
│   │   ├── fixtures/
│   │   │   └── test-data.sql
│   │   ├── utils/
│   │   │   ├── docker-helpers.ts
│   │   │   └── database-helpers.ts
│   │   └── support/
│   │       ├── setup.ts
│   │       └── teardown.ts
│   ├── docker-compose.test.yml
│   ├── .env.test
│   ├── playwright.config.ts
│   └── package.json
├── backend/
├── frontend/
├── database/
└── docker-compose.yml
```

### Testing Stack
- **Playwright**: Browser automation and UI testing
- **Jest**: Test assertions and utilities
- **node-postgres (pg)**: Direct database operations for test data setup
- **Docker Compose**: Isolated test environment

## Test Implementation

### 1. Infrastructure Tests

#### tests/e2e/specs/infrastructure.spec.ts
```typescript
import { test, expect } from '@playwright/test'
import { DockerHelpers } from '../utils/docker-helpers'
import { DatabaseHelpers } from '../utils/database-helpers'

test.describe('Infrastructure Tests', () => {
  test('containers run and are healthy', async () => {
    await DockerHelpers.startTestEnvironment()

    // All containers running
    const containers = await DockerHelpers.getRunningContainers()
    expect(containers.filter(c => c.includes('postgres'))).toHaveLength(1)
    expect(containers.filter(c => c.includes('backend'))).toHaveLength(1)
    expect(containers.filter(c => c.includes('frontend'))).toHaveLength(1)

    // Health checks pass
    await expect(DockerHelpers.waitForHealthy('postgres')).resolves.toBe(true)
    await expect(DockerHelpers.waitForHealthy('backend')).resolves.toBe(true)
    await expect(DockerHelpers.waitForHealthy('frontend')).resolves.toBe(true)
  })

  test('environment variables loaded and database connectivity', async () => {
    // Test database connection from backend
    const dbConnected = await DatabaseHelpers.testConnection()
    expect(dbConnected).toBe(true)

    // Test environment variables by checking backend responds
    const response = await fetch('http://localhost:3002/api/v1/activity-logs')
    expect(response.status).toBe(200)
  })
})
```

### 2. Data Flow Tests

#### tests/e2e/specs/data-flow.spec.ts
```typescript
import { test, expect, Page } from '@playwright/test'
import { DatabaseHelpers } from '../utils/database-helpers'

test.describe('End-to-End Data Flow Tests', () => {
  let page: Page

  test.beforeEach(async ({ browser }) => {
    page = await browser.newPage()
    await DatabaseHelpers.clearTestData()
  })

  test('manual log e2e flow', async () => {
    // Insert manual log directly into database
    const activityId = await DatabaseHelpers.insertActivityLog('manual')
    await DatabaseHelpers.insertManualLog(activityId, 'Test manual log content from DB')

    // Navigate to frontend
    await page.goto('http://localhost:3001')

    // Verify frontend displays the manual log
    await expect(page.locator('[data-testid="log-entry"]')).toContainText('Test manual log content from DB')
    await expect(page.locator('[data-testid="log-type"]')).toContainText('manual')

    // Test edit functionality
    await page.click('[data-testid="edit-log-button"]')
    await page.fill('[data-testid="edit-content"]', 'Updated content via UI')
    await page.click('[data-testid="save-button"]')

    // Verify database reflects UI changes
    const updatedContent = await DatabaseHelpers.getManualLogContent(activityId)
    expect(updatedContent).toBe('Updated content via UI')

    // Test delete functionality
    await page.click('[data-testid="delete-log-button"]')
    await expect(page.locator('[data-testid="log-entry"]')).toHaveCount(0)

    // Verify database deletion
    const logExists = await DatabaseHelpers.activityLogExists(activityId)
    expect(logExists).toBe(false)
  })

  test('git commit e2e flow', async () => {
    // Insert git commit data into database
    const activityId = await DatabaseHelpers.insertActivityLog('git_commit')
    await DatabaseHelpers.insertGitCommit(activityId, {
      commitHash: 'abc123def',
      message: 'feat: add new feature',
      authorName: 'Test Author',
      filesChanged: ['src/app.ts', 'src/utils.ts']
    })

    await page.goto('http://localhost:3001')

    // Verify frontend displays git commit details
    await expect(page.locator('[data-testid="log-entry"]')).toContainText('feat: add new feature')
    await expect(page.locator('[data-testid="commit-hash"]')).toContainText('abc123def')
    await expect(page.locator('[data-testid="author-name"]')).toContainText('Test Author')
    await expect(page.locator('[data-testid="files-changed"]')).toContainText('src/app.ts')

    // Verify read-only (no edit/delete buttons)
    await expect(page.locator('[data-testid="edit-log-button"]')).toHaveCount(0)
    await expect(page.locator('[data-testid="delete-log-button"]')).toHaveCount(0)

    // Test mark as reviewed
    await page.click('[data-testid="mark-reviewed-button"]')
    const isReviewed = await DatabaseHelpers.isActivityLogReviewed(activityId)
    expect(isReviewed).toBe(true)
  })

  test('claude code conversation e2e flow', async () => {
    const activityId = await DatabaseHelpers.insertActivityLog('claude_code')
    await DatabaseHelpers.insertClaudeCodeConversation(activityId, {
      projectDirectoryName: 'my-project',
      conversationFilePath: '/path/to/conversation.jsonl',
      numExchanges: 15,
      numToolUsages: 8,
      startedAt: new Date()
    })

    await page.goto('http://localhost:3001')

    // Verify frontend displays conversation details
    await expect(page.locator('[data-testid="project-name"]')).toContainText('my-project')
    await expect(page.locator('[data-testid="exchanges-count"]')).toContainText('15')
    await expect(page.locator('[data-testid="tools-count"]')).toContainText('8')

    // Verify read-only
    await expect(page.locator('[data-testid="edit-log-button"]')).toHaveCount(0)

    // Test mark as reviewed
    await page.click('[data-testid="mark-reviewed-button"]')
    const isReviewed = await DatabaseHelpers.isActivityLogReviewed(activityId)
    expect(isReviewed).toBe(true)
  })

  test('git checkout e2e flow', async () => {
    const activityId = await DatabaseHelpers.insertActivityLog('git_checkout')
    await DatabaseHelpers.insertGitCheckout(activityId, {
      prevBranch: 'main',
      newBranch: 'feature/new-feature',
      repoName: 'my-repo',
      repoPath: '/path/to/repo'
    })

    await page.goto('http://localhost:3001')

    // Verify frontend displays checkout details
    await expect(page.locator('[data-testid="branch-change"]')).toContainText('main → feature/new-feature')
    await expect(page.locator('[data-testid="repo-name"]')).toContainText('my-repo')

    // Verify read-only and can mark as reviewed
    await expect(page.locator('[data-testid="edit-log-button"]')).toHaveCount(0)
    await page.click('[data-testid="mark-reviewed-button"]')
    const isReviewed = await DatabaseHelpers.isActivityLogReviewed(activityId)
    expect(isReviewed).toBe(true)
  })

  test('git hooks installation e2e flow', async () => {
    const activityId = await DatabaseHelpers.insertActivityLog('git_hook_install')
    await DatabaseHelpers.insertGitHooksInstalled(activityId, {
      hookType: 'post-checkout',
      repoName: 'my-repo',
      repoPath: '/path/to/repo',
      hookScriptPath: '/path/to/hook/script'
    })

    await page.goto('http://localhost:3001')

    // Verify frontend displays hook installation details
    await expect(page.locator('[data-testid="hook-type"]')).toContainText('post-checkout')
    await expect(page.locator('[data-testid="repo-name"]')).toContainText('my-repo')

    // Verify read-only and can mark as reviewed
    await expect(page.locator('[data-testid="edit-log-button"]')).toHaveCount(0)
    await page.click('[data-testid="mark-reviewed-button"]')
    const isReviewed = await DatabaseHelpers.isActivityLogReviewed(activityId)
    expect(isReviewed).toBe(true)
  })
})
```

### 3. Complete Workflow Tests

#### tests/e2e/specs/workflows.spec.ts
```typescript
import { test, expect, Page } from '@playwright/test'
import { DatabaseHelpers } from '../utils/database-helpers'
import { DockerHelpers } from '../utils/docker-helpers'

test.describe('Complete Workflow Tests', () => {
  let page: Page

  test.beforeEach(async ({ browser }) => {
    page = await browser.newPage()
    await DatabaseHelpers.clearTestData()
  })

  test('filtering and review workflow', async () => {
    // Insert test data - mix of reviewed/unreviewed, different types, different dates
    const manualId = await DatabaseHelpers.insertActivityLog('manual', false, new Date('2024-01-01'))
    await DatabaseHelpers.insertManualLog(manualId, 'Unreviewed manual log')

    const gitId = await DatabaseHelpers.insertActivityLog('git_commit', true, new Date('2024-01-02'))
    await DatabaseHelpers.insertGitCommit(gitId, { commitHash: 'abc123', message: 'Reviewed commit' })

    const claudeId = await DatabaseHelpers.insertActivityLog('claude_code', false, new Date('2024-01-03'))
    await DatabaseHelpers.insertClaudeCodeConversation(claudeId, { projectDirectoryName: 'test' })

    await page.goto('http://localhost:3001')

    // Verify all logs initially displayed chronologically
    const logEntries = page.locator('[data-testid="log-entry"]')
    await expect(logEntries).toHaveCount(3)

    // Apply date range filter
    await page.fill('[data-testid="date-from"]', '2024-01-02')
    await page.fill('[data-testid="date-to"]', '2024-01-03')
    await page.click('[data-testid="apply-filters"]')

    await expect(logEntries).toHaveCount(2) // Should exclude 2024-01-01 log

    // Apply unreviewed filter
    await page.selectOption('[data-testid="reviewed-filter"]', 'false')
    await page.click('[data-testid="apply-filters"]')

    await expect(logEntries).toHaveCount(1) // Only unreviewed Claude Code log

    // Bulk mark as reviewed
    await page.click('[data-testid="select-all"]')
    await page.click('[data-testid="mark-selected-reviewed"]')

    // Verify database updated
    const isClaudeReviewed = await DatabaseHelpers.isActivityLogReviewed(claudeId)
    expect(isClaudeReviewed).toBe(true)

    // Clear filters
    await page.click('[data-testid="clear-filters"]')
    await expect(logEntries).toHaveCount(3) // All logs shown again
  })

  test('manual log creation workflow', async () => {
    await page.goto('http://localhost:3001')

    // Create manual log via UI
    await page.click('[data-testid="create-manual-log-button"]')
    await page.fill('[data-testid="manual-log-content"]', 'New manual log via UI')
    await page.click('[data-testid="submit-button"]')

    // Verify appears in frontend immediately
    await expect(page.locator('[data-testid="log-entry"]')).toContainText('New manual log via UI')

    // Verify database entries created
    const activityLogs = await DatabaseHelpers.getAllActivityLogs()
    expect(activityLogs).toHaveLength(1)
    expect(activityLogs[0].type).toBe('manual')
    expect(activityLogs[0].reviewed).toBe(false)

    const manualLog = await DatabaseHelpers.getManualLogContent(activityLogs[0].id)
    expect(manualLog).toBe('New manual log via UI')
  })

  test('data persistence across container restarts', async () => {
    // Insert test data
    const activityId = await DatabaseHelpers.insertActivityLog('manual')
    await DatabaseHelpers.insertManualLog(activityId, 'Persistent test data')

    await page.goto('http://localhost:3001')

    // Verify data shows initially
    await expect(page.locator('[data-testid="log-entry"]')).toContainText('Persistent test data')

    // Restart containers
    await DockerHelpers.restartAllContainers()
    await DockerHelpers.waitForAllHealthy()

    // Refresh and verify data persists
    await page.reload()
    await expect(page.locator('[data-testid="log-entry"]')).toContainText('Persistent test data')

    // Double-check database
    const logExists = await DatabaseHelpers.activityLogExists(activityId)
    expect(logExists).toBe(true)
  })
})
```

## Test Execution

### Running Tests
```bash
# Full test suite
npm run test:e2e

# Individual test categories
npm run test:infrastructure
npm run test:data-flow
npm run test:workflows
```

### Success Criteria

**System fully functional when all tests pass:**

1. **Infrastructure**: Docker containers run, environment configured, database connected
2. **Data Flow**: All 5 activity log types flow correctly from database → API → UI
3. **UI Interactions**: Manual logs can be created, edited, deleted through UI
4. **Read-only Events**: Git/Claude events display correctly but prevent editing
5. **Filtering**: Date/type/review status filters work correctly
6. **Persistence**: Data survives container restarts
7. **Review Workflow**: Logs can be marked as reviewed individually and in bulk

**Total Execution Time**: ~3 minutes for complete test suite

This focused approach tests the core end-to-end functionality that proves the system works as designed through v0.7.